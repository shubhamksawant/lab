name: üöÄ GitOps CD - Dynamic Tunnel Sync

on:
  push:
    branches: [main, develop, qa]
    paths:
      - 'helm-chart/**'

jobs:
  ###################################################
  # JOB 1: REFRESH (Always Runs Automatically)
  ###################################################
  refresh-argocd:
    name: üîÑ Refresh ArgoCD
    runs-on: ubuntu-latest
    steps:
      - name: üîê Setup Dynamic Kubeconfig
        run: |
          mkdir -p ~/.kube
          # 1. Decode the static config
          echo "${{ secrets.KUBECONFIG_STATIC }}" | base64 -d > ~/.kube/config
          
          # 2. Patch the server address with the current ngrok tunnel
          # We use | as a delimiter in sed because the URL contains slashes
          sed -i "s|server:.*|server: https://${{ secrets.NGROK_URL }}|g" ~/.kube/config
          
          # 3. Disable TLS verification because the certificate is for 127.0.0.1, not ngrok
          sed -i "/certificate-authority-data:.*/d" ~/.kube/config
          sed -i "/cluster:/a \    insecure-skip-tls-verify: true" ~/.kube/config
          
          chmod 600 ~/.kube/config
          kubectl cluster-info

      - name: üîÑ Trigger ArgoCD Hard Refresh
        run: |
          echo "Force-refreshing humor-game-monitor..."
          kubectl annotate application humor-game-monitor -n argocd \
            argocd.argoproj.io/refresh=hard --overwrite

  ###################################################
  # JOB 2: SYNC (Waits for Manual Approval)
  ###################################################
  deploy-sync:
    name: üöÄ Approval & Sync
    needs: refresh-argocd
    runs-on: ubuntu-latest
    # This ENVIRONMENT line triggers the manual approval button in GitHub UI
    environment: ${{ (github.ref_name == 'main' && 'production') || (github.ref_name == 'qa' && 'qa') || 'development' }}
    
    steps:
      - name: üîê Setup Dynamic Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_STATIC }}" | base64 -d > ~/.kube/config
          sed -i "s|server:.*|server: https://${{ secrets.NGROK_URL }}|g" ~/.kube/config
          sed -i "/certificate-authority-data:.*/d" ~/.kube/config
          sed -i "/cluster:/a \    insecure-skip-tls-verify: true" ~/.kube/config
          chmod 600 ~/.kube/config

      - name: üì¢ Slack - Requesting Approval
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: workflow,repo
          custom_payload: |
            {
              "attachments": [{
                "color": "#ebba34",
                "title": "üõë Deployment Approval Required",
                "text": "Environment: *${{ github.ref_name }}*\nArgoCD refreshed via Tunnel. Please approve to Sync.",
                "actions": [{
                  "type": "button",
                  "text": "Approve Sync",
                  "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: üöÄ Trigger Sync (Native Kubectl Patch)
        run: |
          echo "Deployment approved! Initiating sync on local k3d..."
          kubectl patch application humor-game-monitor -n argocd \
            --type='merge' \
            -p='{"operation":{"sync":{}}}'

      - name: ‚è≥ Wait for Sync
        run: |
          kubectl wait --for=jsonpath='{.status.sync.status}'=Synced application/humor-game-monitor -n argocd --timeout=120s

      - name: üì¢ Slack - Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "‚úÖ *Sync Successful!* humor-game-monitor is live on your local system."
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}