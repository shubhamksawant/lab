name: üöÄ DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ develop ]
  workflow_dispatch:

env:
  # Registry URL is now GHCR (ghcr.io)
  # Uses the repository owner as the base for the registry path
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: humor-game-backend
  IMAGE_NAME_FRONTEND: humor-game-frontend
  REPO_OWNER: ${{ github.repository_owner }} # Used to construct the full GHCR image path

jobs:
  ###################################################
  # JOB 1: SECURITY & TEST (Shift-Left/Fail-Fast)
  ###################################################
  security-and-test:
    name: üõ°Ô∏è Security Checks & Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for SonarCloud PR analysis
          
      - name: üì¶ Setup Node.js & Install dependencies
        uses: actions/setup-node@v4
        with:
          node-version: 18
          
      - name: ‚¨áÔ∏è Install Node.js Dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci
          
      # # --- TRIVY FILESYSTEM SCAN (SCA, Secrets, IaC/Config) ---
      # # This performs the Dependency Scan (SCA) by analyzing package-lock.json
      # - name: üîç Trivy Filesystem Scan (SCA, Secrets, Config)
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'fs'
      #     scan-ref: '.'
      #     scanners: 'vulnerability,misconfiguration,secret' 
      #     severity: 'CRITICAL,HIGH' 
      #     exit-code: 1
      #     format: 'table'
      #     output: 'trivy-fs-report.txt'

      
      # - name: ‚¨ÜÔ∏è Upload Trivy Report Artifact
      #   # CRITICAL FIX: Add 'if: always()' to ensure this runs even if Trivy fails
      #   if: always() 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: trivy-fs-report-${{ github.sha_short }}
      #     path: trivy-fs-report.txt
      #     retention-days: 7

          
      # --- UNIT TESTS ---
      - name: üß™ Run Unit Tests
        run: |
          cd backend && npm test
          cd ../frontend && npm test

# --- NOTIFICATION STEP (Run Always) ---
      - name: üì¢ Slack Notification Security Status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#devops'
          text: |
            *üõ°Ô∏è JOB 1 STATUS: Security Checks & Tests*
            
            *Status:* ${{ job.status }}
            *Repo:* ${{ github.repository }}
            *Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline Run #${{ github.run_number }}>
            *Summary:* Static Analysis (SonarCloud) and Unit Tests complete.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  ###################################################
  # JOB 2: BUILD, PUSH & ARTIFACT SECURITY
  ###################################################
  build-and-push:
    name: üèóÔ∏è Build, Scan, and Push Images
    runs-on: ubuntu-latest
    needs: [security-and-test]
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üê≥ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: üîê Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }} # Use the GitHub Actor for GHCR login
          password: ${{ secrets.GITHUB_TOKEN }} # Use the GITHUB_TOKEN (requires 'write:packages' permission)
      
      # # --- TRIVY k8s CONFIG SCAN (Config Security) ---
      # - name: ‚öôÔ∏è Trivy k8s Scan on Kustomize Configs
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'config'
      #     scan-ref: 'gitops-safe' # Target your Kustomize folder for K8s misconfigs
      #     security-checks: 'config'
      #     severity: 'CRITICAL,HIGH' # Fail if insecure K8s config is detected
      #     exit-code: 1
      #     format: 'table'
      #     output: 'trivy-k8s-config-report.txt'

      
      # - name: ‚¨ÜÔ∏è Upload Trivy Report Artifact
      #   if: always() 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: trivy-k8s-config-report-${{ github.sha_short }}
      #     path: 'trivy-k8s-config-report.txt'
      #     retention-days: 7




     # --- BUILD BACKEND IMAGE (STAGING ARTIFACT) ---
      - name: üèóÔ∏è Build Backend Image
        uses: docker/build-push-action@v5
        id: build_backend
        with:
          context: ./backend
          push: false # Keep this to scan before pushing
          tags: ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
          # CRITICAL FIX: Load the image into the Docker daemon so Trivy can see it
          outputs: type=docker 

      # # --- TRIVY IMAGE SCAN (Backend Artifact Security) ---
      # # This step will now successfully find the image locally
      # - name: üîç Trivy Image Scan (Backend)
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'image'
      #     image-ref: ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
      #     severity: 'CRITICAL,HIGH' 
      #     exit-code: 1 
      #     format: 'table'
      #     output: 'trivy-backend-image-report.txt'

      
      # - name: ‚¨ÜÔ∏è Upload Trivy Report Artifact
      #   if: always() 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: trivy-backend-image-report-${{ github.sha_short }}
      #     path: 'trivy-backend-image-report.txt'
      #     retention-days: 7

      - name: üöÄ Push Backend to GHCR
        if: success() # Only push if scan passed
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_BACKEND }}:latest

      # --- BUILD, SCAN, AND PUSH FRONTEND ---
      - name: üèóÔ∏è Build Frontend Image
        uses: docker/build-push-action@v5
        id: build_frontend
        with:
          context: ./frontend
          push: false # Build locally first
          tags: ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
          # CRITICAL FIX: Load the image into the Docker daemon so Trivy can see it
          outputs: type=docker

      # - name: üîç Trivy Image Scan (Frontend)
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'image'
      #     image-ref: ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
      #     severity: 'CRITICAL,HIGH' # Fail if vulnerable image is detected
      #     exit-code: 1 
      #     format: 'table'
      #     output: 'trivy-frontend-image-report.txt'

      # - name: ‚¨ÜÔ∏è Upload Trivy Report Artifact
      #   if: always() 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: trivy-frontend-image-report-${{ github.sha_short }}
      #     path: 'trivy-frontend-image-report.txt'
      #     retention-days: 7

      - name: üöÄ Push Frontend to GHCR
        if: success() # Only push if scan passed
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_FRONTEND }}:latest

       # --- NOTIFICATION STEP (Run Always) ---
      - name: üì¢ Slack Notification Build & Artifact Status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#devops'
          text: |
            *üì¶ JOB 2 STATUS: Build & Artifact Security*
            
            *Status:* ${{ job.status }}
            *Artifacts:* Backend and Frontend Images
            *Target:* GHCR (${{ env.REPO_OWNER }})
            *Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline Run #${{ github.run_number }}>
            *Summary:* Artifacts built and passed Trivy Image Scan. Ready for deployment.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}


  ###################################################
  # JOB 3: PROMOTE TO ENVIRONMENT (Update Helm Values + PR)
  ###################################################
  promote-to-environment:
    name: üöÄ Promote to Environment (Helm Values PR)
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success()
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Determine environment, values file, and branch name
        id: env
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"  # First 7 characters of commit SHA

          if [[ "${{ github.ref_name }}" == "develop" ]]; then
            ENV_NAME="dev"
            VALUES_FILE="lab/helm-chart/values-dev.yaml"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            ENV_NAME="prod"
            VALUES_FILE="lab/helm-chart/values-prod.yaml"
          elif [[ "${{ github.ref_name }}" == "qa" ]]; then
            ENV_NAME="qa"
            VALUES_FILE="lab/helm-chart/values-qa.yaml"
          else
            echo "Unsupported branch: ${{ github.ref_name }}"
            exit 1
          fi

          PROMOTE_BRANCH="helm/tag-update-to-$ENV_NAME-$SHORT_SHA"

          echo "name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "file=$VALUES_FILE" >> $GITHUB_OUTPUT
          echo "branch=$PROMOTE_BRANCH" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: üõ†Ô∏è Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üåø Create temporary promotion branch
        run: |
          git checkout -b ${{ steps.env.outputs.branch }}

      - name: ‚úèÔ∏è Update image tags in values file
        env:
          NEW_TAG: ${{ steps.env.outputs.short_sha }}
          VALUES_FILE: ${{ steps.env.outputs.file }}
        run: |
          # Update all lines that have "tag:" (both backend and frontend)
          sed -i "s|^\(\s*tag:\s*\).*|\1$NEW_TAG|" "$VALUES_FILE"

          echo "Updated $VALUES_FILE with new tag: $NEW_TAG"
          git diff --color "$VALUES_FILE" || true

      - name: üì§ Commit and push changes
        run: |
          git add ${{ steps.env.outputs.file }}
          git commit -m "chore(helm): update ${{ steps.env.outputs.name }} image tags to ${{ steps.env.outputs.short_sha }}"
          git push origin ${{ steps.env.outputs.branch }} --force

      - name: üîÑ Create Pull Request targeting the original branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: |
            **Automated GitOps Tag Update**

            This PR updates the image tags in the Helm values file for the **${{ steps.env.outputs.name }}** environment.

            **File updated**: `${{ steps.env.outputs.file }}`

            **New image tag applied**: `${{ steps.env.outputs.short_sha }}`

            **Updated images**:
            - **Backend**: 
              `${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.env.outputs.short_sha }}`
            - **Frontend**: 
              `${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.env.outputs.short_sha }}`

            Triggered from commit ${{ github.sha }} on branch `${{ github.ref_name }}`.

            Merging this PR will deploy the new version via your GitOps tool (ArgoCD, Flux, etc.).
        run: |
          gh pr create \
            --base ${{ github.ref_name }} \
            --head ${{ steps.env.outputs.branch }} \
            --title "Deploy tag ${{ steps.env.outputs.short_sha }} to ${{ steps.env.outputs.name }} environment" \
            --body "$PR_BODY" \
            --label "automated" \
            --label "deployment" \
            --label "${{ steps.env.outputs.name }}" \
            --label "tag-update"

      - name: üì¢ Slack Notification - Promotion PR Created
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#devops'
          text: |
            *üöÄ Promotion PR Created*

            A new pull request has been opened to deploy tag **${{ steps.env.outputs.short_sha }}** to the **${{ steps.env.outputs.name }}** environment.

            **File**: ${{ steps.env.outputs.file }}

            View PR: <$(gh pr view ${{ steps.env.outputs.branch }} --json url --jq .url)|PR Link>

            Merge to deploy!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

          









  # ###################################################
  # # JOB 4: NOTIFY
  # ###################################################
  # notify:
  #   name: üì¢ Notify Team
  #   runs-on: ubuntu-latest
  #   needs: [build-and-push]
  #   if: always()
    
  #   steps:
  #     - name: üì¢ Slack notification
  #       uses: 8398a7/action-slack@v3
  #       with:
  #         status: ${{ job.status }}
  #         channel: '#deployments'
  #         text: |
  #           üöÄ Deployment ${{ job.status }} for Humor Memory Game
  #           Commit: ${{ github.sha }}
  #           Branch: ${{ github.ref_name }}
  #           Environment: Production
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
